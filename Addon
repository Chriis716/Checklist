function Sync-UiToState {
    if (-not $script:currentState) { return }

    foreach ($sec in $script:allSections) {
        foreach ($item in $sec.Items) {

            $itemId = [string]$item.Id
            Ensure-ItemState $script:currentState $itemId
            $entry = Get-ItemStateEntry -state $script:currentState -id $itemId

            $entry.isChecked  = [bool]$item.IsChecked
            $entry.checkedUtc = $item.CheckedUtc
            $entry.notes      = [string]$item.Notes

            Set-ItemStateEntry -state $script:currentState -id $itemId -value $entry
        }
    }
}



function Save-Current {
    if (-not $script:currentState) {
        Set-Status "Nothing loaded yet."
        return
    }

    Sync-UiToState
    Save-State $script:currentState
    Set-Status "Saved: $($script:currentState.changeId)"
}

$window.add_Closing({
    if ($script:currentState) {
        $script:currentState.window.left   = $window.Left
        $script:currentState.window.top    = $window.Top
        $script:currentState.window.width  = $window.Width
        $script:currentState.window.height = $window.Height

        Sync-UiToState
        Save-State $script:currentState
    }
})
